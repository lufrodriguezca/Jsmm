# R/plot_trajectories.R

#' Plot movement trajectories.
#'
#' The function allows visualization of the movement trajectories generated by the function simulate_trajectories().
#'
#' @param m Named list that contains all the model components for running Joint species movement modelling (Jsmm) analyses.
#' @param plot_sp vector composed of integers representing the species index to visualize.
#' @param customize_plot list with predefined settings for visualization.
#'
#' @return NULL. Visualization function.
#' @export
#'

plot_trajectories = function(m = m, plot_sp = NULL, customize_plot = NULL){
  trajectories = m[["trajectories"]]
  domain = m$domain

  if(nrow(trajectories) > 0){
    if(is.null(plot_sp)){
      plot_sp = sort(unique(m[["releases"]][, 1]))
    }

    if(is.null(customize_plot$trajectory_color)){
      customize_plot$trajectory_color = sample(colors(), length(plot_sp), replace = FALSE)
    }
    if(is.null(customize_plot$trajectory_lwd)){
      customize_plot$trajectory_lwd = 1
    }

    traj = c()
    for(s in plot_sp){
      indList = which(m[["releases"]][, 1] == s)
      if(length(indList)>0){
        trajectory = matrix(trajectories[, indList],ncol = length(indList))

        traj_line = list()
        c=0
        for (i in 1:ncol(trajectory)){ #
          seg = matrix(domain$triangulation$node[trajectory[which(!is.na(trajectory[, i]) ), i], ], ncol = 2 )
            c = c + 1
            traj_line[[c]] = seg
        }
        trajs = list()
        trajs[[1]] =  sf::st_multilinestring(traj_line)
        trajs = sf::st_sf(sp = s, geometry = st_sfc(trajs))
      }
      traj = rbind(traj, trajs)
    }
  }

  customize_plot = preset_dom_plot(domain, customize_plot)
  center_location = centroid_locations(domain$polygon)
  nsites  = nrow(center_location)

  d = (ggplot2::ggplot(data = domain$polygon)
      + ggplot2::geom_sf(data = domain$polygon[which(domain$polygon$id > 0), ], aes(fill = factor(id)),
                color = customize_plot$color_polyb, lwd = customize_plot$lwd_poly)
      + scale_fill_manual(values = customize_plot$color_map, labels = customize_plot$lab_legend, name = customize_plot$name_legend)
      + ggplot2::geom_sf(data = domain$polygon[which(domain$polygon$id_location != 0), ], fill = customize_plot$site_col , color = customize_plot$siteb_col,
                lwd = customize_plot$lwd_poly)
      + ggplot2::geom_text(data = center_location, aes(x = x_centroid, y = y_centroid, label = id_location), size = customize_plot$site_text_size,
                  nudge_y = rep(customize_plot$site_text_pos[1], nsites),
                  nudge_x = rep(customize_plot$site_text_pos[2], nsites))
      + xlab(customize_plot$labs_axis[1])
      + ylab(customize_plot$labs_axis[2])

      + theme(panel.border = element_rect(fill = NA, color = customize_plot$panelb_color, size = customize_plot$panelb_lwd),
              panel.background = element_rect(fill = NA)))

  if(ncol(trajectory) > 0){
    (d + ggplot2::geom_sf(data=traj[which(traj$sp %in% plot_sp ), ], color = customize_plot$trajectory_color[plot_sp], lwd = customize_plot$trajectory_lwd))
  }else{
    d
  }
}

